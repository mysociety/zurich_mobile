Zurich Mobile App
=================

A mobile app for www.zueriwieneu.ch based on mSociety's FixMyStreet platform.

Setup
-----
This project uses Apache Cordova to produce Android and iOS apps. There is
some mildly complicated configuration and setup required to be able to develop
with it. The following all assumes you're working on a Mac.

1. Make sure you have the latest versions of XCode, JDK 1.8, the Android SDK, node and
npm installed. It's a very good idea to have installed the Intel HAXM versions
of the Android emulator because they're about 100 times faster to run. You need
to download it from the Android SDK Manager (run `android` on the command line)
and then actually run the `.dmg` that this creates in your sdk folder. (Alternatively `brew cask install intel-haxm` if you use [Homebrew Cask](http://caskroom.io).)

2. Install the cordova CLI with npm: `npm install -g cordova`
Note that this is not the same as the phonegap CLI and the two should not be
mixed up. The latter gives you access to Adobe's proprietary phonegap build
service, which we **don't** use!

3. Install the "Android 4.4.2 (API 19)" and "Android SDK Build-tools" packages within the Android SDK Manager (run `android` on the command line)

4. Checkout the project

5. `cd` into the project directory and install the Cordova platforms you need:
`cordova platform add android` and `cordova platform add ios`. You need to ensure `ANDROID_HOME` and `JAVA_HOME` environment variables are set correctly beforehand.

6. Add the cordova plugins we use. As of writing the list is: (from `cordova plugin list`)

   ```
   org.apache.cordova.battery-status 0.2.11 "Battery"
   org.apache.cordova.camera 0.3.2 "Camera"
   org.apache.cordova.contacts 0.2.13 "Contacts"
   org.apache.cordova.device 0.2.12 "Device"
   org.apache.cordova.device-motion 0.2.10 "Device Motion"
   org.apache.cordova.device-orientation 0.3.9 "Device Orientation"
   org.apache.cordova.dialogs 0.2.10 "Notification"
   org.apache.cordova.file 1.3.1 "File"
   org.apache.cordova.file-transfer 0.4.6 "File Transfer"
   org.apache.cordova.geolocation 0.3.10 "Geolocation"
   org.apache.cordova.globalization 0.3.1 "Globalization"
   org.apache.cordova.media 0.2.13 "Media"
   org.apache.cordova.media-capture 0.3.3 "Capture"
   org.apache.cordova.network-information 0.2.12 "Network Information"
   org.apache.cordova.splashscreen 0.3.3 "Splashscreen"
   org.apache.cordova.statusbar 0.1.10 "StatusBar"
   ```

   So to install them: `cordova plugin add org.apache.cordova.battery-status org.apache.cordova.camera org.apache.cordova.contacts org.apache.cordova.device org.apache.cordova.device-motion org.apache.cordova.device-orientation org.apache.cordova.dialogs org.apache.cordova.file org.apache.cordova.file-transfer org.apache.cordova.geolocation org.apache.cordova.globalization org.apache.cordova.media org.apache.cordova.media-capture org.apache.cordova.network-information org.apache.cordova.splashscreen org.apache.cordova.statusbar`

   (These might be installed automatically, I'm not totally sure how Cordova remembers them)

7. Install Apache Ant (`brew install ant`, if you use Homebrew) for Android build support, and `ios-sim` (`npm install -g ios-sim`) for iOS simulator support.

8. Create a new 'Android Virtual Device' for emulating a real device by running `android avd` and using one of the 'Device Definitions' on the second tab as a template. It doesn't matter which one, but set the CPU type to 'Atom (x86)' otherwise it will be very very slow. Enable 'Use Host GPU', if available, to massively speed up the UI. Ticking 'Hardware keyboard present' will allow you to use your keyboard instead of hunting-and-pecking the on-screen keyboard.

9. Copy `www/js/config.js-example to www/js/config.js` and edit if needed

10. To run the project on one of the platforms, use: `cordova emulate ios` or `cordova emulate android`

Tips and Tricks
--------------
- Make sure you read the documentation for Cordova from http://cordova.apache.org/
**not the Phonegap site** - the two vary in infuriating and subtle ways and much
of the stackoverflow-esque info on the web is confused about which one it's for.
Particularly in the options for things in `config.xml` which is where all the
magic happens.
- You can use `ios-sim` to launch the iOS emulator directly with something like:
`ios-sim launch platforms/ios/build/emulator/Zuri\ Wie\ Neu.app --devicetypeid "com.apple.CoreSimulator.SimDeviceType.iPhone-6, 8.0"` after you've built the project via a previous
emulator run or a direct build via `cordova build ios`. This allows you to
specify a different device than the default one. To see the available options
for `--devicetypeid` run `ios-sim showdevicetypes`.
- You can open the iOS project in XCode if you prefer to run it that way, the
project file is in `platforms/ios`
- The `platforms`, `plugins` and `hooks` folders are auto-generated by Cordova
no need to check them in (hence why they're .gitignored), you should only need
to check in the `www` folder and `config.xml`, plus possibly `/merges` if you
ever use that functionality.
- To check the console log output when emulating iOS, run: `tail -f console.log`
Cordova by default writes it out to that file in your project root
- To check the console log output when emulating Android, cd to
`platforms/android/cordova` and run `./log`. I found that I needed to be in the
directory for it to actually print anything, YMMV.
- Leave the emulators running once they start, it's much quicker!
- If you're using your own FMS backend, you'll need to add an `<access origin="" />` tag to `config.xml` to allow access from within the app. **Make sure** you remove any such lines before building/committing!

Releasing
---------
### Android
To release the app on Android, you need to do the following:

1. Change your config.js to include production settings

2. Bump the version code in config.xml, both the main one and the android specific one

2. Build a release version of the app: `cordova build android --release`

3. Sign that `.apk` (the cordova command tells you where it put it):
    1. Clone the mySociety keys repository
    2. `cd` into the folder containing your new release `.apk`
    3. Sign the .apk with our key: `jarsigner -verbose -keystore <path-to-keys-repo>keys/android/android_keystore -sigalg SHA1withRSA -digestalg SHA1 ZuriWieNeu-release-unsigned.apk fixmyzurich` Double check that you're signing the right .apk here as there
    will be debug ones too.

      This will ask first for a password for the keystore (it's in the usual place
      if you're a mysociety developer), then a password for the app specific key,
      (`fixmyzurich` in the command above is a special shortname for the app that
      identifies which key to use.)

4. Verify that the signing was ok: `jarsigner -verify -verbose -certs ZuriWieNeu-release-unsigned.apk` (The signing doesn't change the name of your `.apk`). You should
see `sm` next to every file.

5. Align the `.apk` using `zipalign` (Note, you might have to manually find `zipalign` in `build-tools` inside the sdk-folder): `zipalign -v 4 ZuriWieNeu-release-unsigned.apk ZuriWieNeu.apk`

Note: most of this comes from: http://developer.android.com/tools/publishing/app-signing.html#signing-manually, you can also do it via Eclipse or Android Studio if you wish.


### iOS

Notes and observations from doing the release process:

 * Whilst the PhoneGap strings in the app are already in German, the native UI presented by iOS (e.g. photo selection) won't be. Add a 'Localizations' key (of type array) to 'Custom iOS Target Properties' in Xcode, with a single string entry of 'German'.
